<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Editor | Admin</title>
    <link rel="icon" type="image/x-icon" href="../img/a2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           YOUR ORIGINAL CSS (Preserved)
           ========================================= */
        :root {
            --primary: #a40028;
            --secondary: #8B0000;
            --accent: #FFD700;
            --light: #F8F9FA;
            --dark: #212529;
            --primary-color: #a40028;
            --secondary-color: #ffcc00;
            --accent-blue: #004080;
            --light-gray: #f8f9fa;
            --dark-gray: #333;
            --white: #ffffff;
            
            /* Admin Colors */
            --admin-edit: #27ae60;
            --admin-delete: #c0392b;
            --admin-add: #2980b9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { line-height: 1.7; color: var(--dark-gray); background-color: var(--light-gray); display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; /* Space for save bar */ }

        /* Header Styles */
        .top-bar { background: var(--primary); color: white; padding: 10px 30px; font-size: 0.9em; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); gap: 40px; }
        .top-bar i { margin-right: 8px; color: var(--accent); }
        .logo-bar { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 20px 30px; min-height: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; gap: 40px; }
        .logo-bar::before { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent)); }
        .logo-container { display: flex; align-items: center; width: 25%; gap: 20px; }
        .left-logo { justify-content: flex-end; padding-right: 30px; }
        .right-logo { justify-content: flex-start; padding-left: 30px; }
        .zsnhs-logo, .deped-logo { height: 150px; width: auto; object-fit: contain; max-width: 220px; }
        .title-container { display: flex; align-items: center; justify-content: center; flex: 1; padding: 0 20px; }
        .school-name { text-align: center; }
        .school-name h1 { color: var(--primary); font-size: 2.5em; margin: 0; font-weight: 800; line-height: 1.2; text-transform: uppercase; }
        .school-name p { color: var(--secondary); font-size: 1.1em; font-weight: 600; font-style: italic; margin-top: 8px; }
        
        /* --- NAVIGATION & DROPDOWN FIX START --- */
        nav { 
            background: linear-gradient(135deg, var(--primary), #002244); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        
        .nav-links { 
            display: flex; 
            list-style: none; 
            justify-content: center; 
            padding: 0 30px; 
            margin: 0; 
        }
        
        .nav-links > li { 
            position: relative; /* Crucial for dropdown positioning */
        }
        
        /* Show dropdown on hover */
        .nav-links > li:hover .dropdown-menu { 
            display: block; 
        }
        
        .nav-links a { 
            color: white; 
            text-decoration: none; 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.85em; 
            letter-spacing: 1px; 
            padding: 18px 22px; 
            display: block; 
            transition: all 0.3s ease; 
        }
        
        .dropdown-menu { 
            display: none; /* Hidden by default */
            position: absolute; 
            top: 100%; 
            left: 0; 
            background-color: white; /* Clean white background */
            min-width: 220px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.15); 
            z-index: 9999; /* High z-index to sit on top of content */
            border-top: 3px solid var(--accent); /* Accent border on top */
            padding: 0;
            list-style: none;
        }
        
        .dropdown-menu li { 
            border-bottom: 1px solid #f0f0f0; 
        }
        
        .dropdown-menu li:last-child { 
            border-bottom: none; 
        }
        
        .dropdown-menu a { 
            color: var(--dark); 
            padding: 12px 20px; 
            text-transform: none; /* Normal case for sub-items */
            font-size: 0.9em;
        }
        
        .dropdown-menu a:hover { 
            background-color: #f8f9fa; 
            color: var(--primary); 
            padding-left: 25px; /* Slide effect */
        }
        /* --- NAVIGATION & DROPDOWN FIX END --- */

        main { flex: 1; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        /* History Hero */
        .history-hero { 
            background-color: #002244; 
            background-size: cover; background-position: center; 
            height: 60vh; min-height: 400px; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--white); margin-bottom: 60px; position: relative; 
        }
        .hero-content { max-width: 800px; padding: 0 20px; }
        .history-hero h1 { font-size: 3.2rem; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); }
        .hero-subtitle { font-size: 1.4rem; margin-bottom: 30px; font-weight: 300; }

        /* Timeline */
        .timeline-container { max-width: 1100px; margin: 60px auto; padding: 0 20px; }
        .timeline { position: relative; padding: 40px 0; }
        .timeline::before { content: ''; position: absolute; width: 4px; background-color: var(--secondary-color); top: 0; bottom: 0; left: 50%; margin-left: -2px; border-radius: 2px; }
        .timeline-item { padding: 20px 40px; position: relative; width: 50%; box-sizing: border-box; margin-bottom: 30px; }
        .timeline-item.odd { left: 0; }
        .timeline-item.even { left: 50%; }
        .timeline-content { padding: 30px; background: var(--white); border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); position: relative; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .timeline-year { position: absolute; top: 20px; font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .timeline-item.odd .timeline-year { right: -80px; text-align: right; }
        .timeline-item.even .timeline-year { left: -80px; text-align: left; }
        .timeline-dot { position: absolute; width: 20px; height: 20px; background-color: var(--primary-color); border: 4px solid var(--secondary-color); border-radius: 50%; top: 30px; z-index: 1; }
        .timeline-item.odd .timeline-dot { right: -12px; }
        .timeline-item.even .timeline-dot { left: -12px; }

        /* Images */
        .school-image, .campus-image { width: 100%; border-radius: 8px; margin: 20px 0; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); object-fit: cover;}
        .image-caption { text-align: center; font-style: italic; color: #666; margin-top: -15px; margin-bottom: 20px; font-size: 0.9rem; }

        /* Campus Section */
        .campus-section { background-color: var(--white); border-radius: 8px; padding: 40px; margin: 60px auto; max-width: 1100px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
        .campus-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px; }
        .campus-card { background: var(--light-gray); border-radius: 8px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); position: relative; /* Added for controls */ }
        .campus-image { height: 200px; object-fit: cover; margin: 0; border-radius: 0; }
        .campus-info { padding: 20px; }
        .campus-info h3 { color: var(--primary-color); margin-bottom: 10px; }

        .facilities-section { background-color: var(--white); border-radius: 8px; padding: 40px; margin: 60px auto; max-width: 1100px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); position: relative; /* Added for controls */ }

        h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.5rem; }
        p { margin-bottom: 15px; font-size: 1rem; }

        /* Footer */
        footer { background: linear-gradient(135deg, var(--primary), #a40028); color: white; padding: 50px 30px 20px; }
        .footer-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; }
        .footer-section h3 { color: var(--accent); font-size: 1.3em; margin-bottom: 20px; }
        .copyright { text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Responsive */
        @media (max-width: 768px) {
            .logo-bar { flex-direction: column; gap: 20px; }
            .nav-links { display: none; }
            .timeline::before { left: 31px; }
            .timeline-item { width: 100%; padding-left: 70px; padding-right: 25px; }
            .timeline-item.even { left: 0; }
            .timeline-item.odd .timeline-year, .timeline-item.even .timeline-year { left: 0; top: -30px; text-align: left; }
            .timeline-item.odd .timeline-dot, .timeline-item.even .timeline-dot { left: 20px; }
        }

        /* =========================================
           ADMIN UI OVERLAYS
           ========================================= */
        /* The buttons in top-left corners */
        .admin-controls { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            z-index: 100; 
            display: flex; 
            gap: 5px; 
        }
        
        .btn-admin { 
            border: none; 
            padding: 8px 12px; 
            border-radius: 4px; 
            color: white; 
            cursor: pointer; 
            font-size: 0.9em; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            transition: 0.2s; 
        }
        .btn-edit { background-color: var(--admin-edit); }
        .btn-edit:hover { background-color: #219150; }
        
        .btn-delete { background-color: var(--admin-delete); }
        .btn-delete:hover { background-color: #a93226; }
        
        /* Add New Button */
        .btn-add-section {
            display: block;
            margin: 20px auto;
            padding: 12px 25px;
            background-color: var(--admin-add);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-add-section:hover { background-color: #1f618d; }

        /* Fixed Save Bar */
        .save-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); }
        .save-btn { background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .save-btn:hover { background: #c0392b; }

        /* Edit Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .form-group textarea { height: 100px; resize: vertical; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        
        /* Loading Overlay */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3>Loading Content...</h3>
    </div>

    <header>
        <div class="top-bar">
            <div><i class="fas fa-tools"></i> History | Admin</div>
        </div>
        <div class="logo-bar">
            <div class="logo-container left-logo"><img src="../img/zsnhs_logo.jpg" class="zsnhs-logo"></div>
            <div class="title-container"><div class="school-name"><h1>ZAMBOANGA SIBUGAY NATIONAL HIGH SCHOOL</h1></div></div>
            <div class="logo-container right-logo"><img src="../img/deped_logo.jfif" class="deped-logo"></div>
        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="admin.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li>
                    <a href="#"><i class="fas fa-info-circle"></i> About Us <i class="fas fa-caret-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="adminvision.html"><i class="fas fa-bullseye"></i> Mission & Vision</a></li>
                        <li><a href="adminhistory.html"><i class="fas fa-landmark"></i> History</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="fas fa-book"></i> Tracks <i class="fas fa-caret-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="admintvl.html"><i class="fas fa-tools"></i> TVL Tracks</a></li>
                        <li><a href="adminacademic.html"><i class="fas fa-graduation-cap"></i> Academic Tracks</a></li>
                    </ul>
                </li>
                <li><a href="admincontact.html"><i class="fas fa-phone"></i> Contact</a></li>
                <li><a href="AdminLandingPage.html" target="_blank"><i class="fas fa-eye"></i> Events</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="history-hero" id="hero-section">
            <div class="admin-controls">
                <button class="btn-admin btn-edit" onclick="openEditModal('hero')"><i class="fas fa-pen"></i> Edit Banner</button>
            </div>
            <div class="hero-content">
                <h1 id="hero-title-display">History of Zamboanga Sibugay National<br>High School</h1>
                <p class="hero-subtitle" id="hero-subtitle-display">From humble beginnings to a center of educational excellence</p>
            </div>
        </section>

        <div class="timeline-container">
            <h2 style="text-align:center; color:var(--primary);">Historical Timeline</h2>
            <div class="timeline" id="timeline-container">
                </div>
            <button class="btn-add-section" onclick="addItem('timeline')"><i class="fas fa-plus"></i> Add Timeline Event</button>
        </div>

        <section class="campus-section">
            <div class="container">
                <h2>Our Campuses</h2>
                <div class="campus-grid" id="campus-grid">
                    </div>
                <button class="btn-add-section" onclick="addItem('campus')"><i class="fas fa-plus"></i> Add Campus</button>

                <div class="campus-image-container" style="margin-top: 50px; position: relative;">
                    <div class="admin-controls">
                        <button class="btn-admin btn-edit" onclick="openEditModal('current_campus')"><i class="fas fa-pen"></i> Edit Photo</button>
                    </div>
                    <img id="current-campus-img" src="" class="school-image" onerror="this.src='https://placehold.co/800x400/a40028/FFFFFF?text=Campus+Image'">
                    <p id="current-campus-caption" class="image-caption"></p>
                </div>
            </div>
        </section>

        <section class="facilities-section" style="position: relative;">
            <div class="admin-controls">
                <button class="btn-admin btn-edit" onclick="openEditModal('facilities')"><i class="fas fa-pen"></i> Edit Text</button>
            </div>
            <div class="container">
                <h2>Our Facilities and Community</h2>
                <p id="facilities-description">Loading...</p>
            </div>
        </section>
    </main>

    <div class="save-bar">
        <span><i class="fas fa-info-circle"></i> Changes are pending. Click save to publish.</span>
        <button class="save-btn" onclick="saveToDatabase()">SAVE CHANGES</button>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom: 20px; color: var(--primary);">Edit Item</h3>
            <div id="modal-body">
                </div>
            <div class="modal-actions">
                <button class="btn-admin" style="background:#7f8c8d" onclick="closeModal()">Cancel</button>
                <button class="btn-admin btn-edit" onclick="saveModalChanges()">Update Preview</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlClfbOSKAhalafAQ4ptMRCHkaG-DxDd8",
            authDomain: "zsnhs-24e44.firebaseapp.com",
            databaseURL: "https://zsnhs-24e44-default-rtdb.firebaseio.com",
            projectId: "zsnhs-24e44",
            storageBucket: "zsnhs-24e44.firebasestorage.app",
            messagingSenderId: "39166648924",
            appId: "1:39166648924:web:d65f2e83e6143a5aff7c99"
        };
        const supabaseUrl = "https://lydfpvyzlkiemdkfevld.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5ZGZwdnl6bGtpZW1ka2ZldmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODA5ODQsImV4cCI6MjA3OTk1Njk4NH0.cya0vN2jUzylNzNNHUr0rbb1ONd_X5IQFAvb3WUNj9M"; 

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey); 

        // --- 2. STATE MANAGEMENT ---
        let globalData = {
            hero_banner: { title: "History of Zamboanga Sibugay National High School", subtitle: "From humble beginnings...", image: "" },
            timeline: [],
            campuses: [],
            current_campus: { image: "", caption: "" },
            schoolInfo: { facilities: "" }
        };

        let editContext = null; 
        let editIndex = null;

        // --- 3. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            document.getElementById('loader').style.display = 'none';
        });

        async function loadData() {
            try {
                const doc = await db.collection('history').doc('pageContent').get();
                if (doc.exists) {
                    globalData = { ...globalData, ...doc.data() }; 
                }
                renderAll();
            } catch (error) {
                console.error("Error:", error);
                alert("Error loading data");
            }
        }

        function renderAll() {
            // Hero
            const hero = globalData.hero_banner || {};
            document.getElementById('hero-title-display').innerHTML = hero.title || "History of Zamboanga Sibugay National High School";
            document.getElementById('hero-subtitle-display').innerText = hero.subtitle || "Subtitle";
            if(hero.image) {
                document.getElementById('hero-section').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${hero.image}')`;
            }

            // Timeline
            const tContainer = document.getElementById('timeline-container');
            tContainer.innerHTML = '';
            (globalData.timeline || []).sort((a,b) => a.order - b.order).forEach((item, index) => {
                const position = index % 2 === 0 ? 'odd' : 'even';
                tContainer.innerHTML += `
                    <div class="timeline-item ${position}">
                        <div class="admin-controls">
                            <button class="btn-admin btn-edit" onclick="openEditModal('timeline', ${index})"><i class="fas fa-pen"></i></button>
                            <button class="btn-admin btn-delete" onclick="deleteItem('timeline', ${index})"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-year">${item.year}</div>
                        <div class="timeline-content">
                            <h2>${item.title}</h2>
                            <img src="${item.image}" class="school-image" onerror="this.src='https://placehold.co/400x300/a40028/FFFFFF?text=No+Image'">
                            <p class="image-caption">${item.caption || ''}</p>
                            <p>${item.description}</p>
                        </div>
                    </div>
                `;
            });

            // Campuses
            const cContainer = document.getElementById('campus-grid');
            cContainer.innerHTML = '';
            (globalData.campuses || []).forEach((item, index) => {
                cContainer.innerHTML += `
                    <div class="campus-card">
                        <div class="admin-controls">
                            <button class="btn-admin btn-edit" onclick="openEditModal('campus', ${index})"><i class="fas fa-pen"></i></button>
                            <button class="btn-admin btn-delete" onclick="deleteItem('campus', ${index})"><i class="fas fa-trash"></i></button>
                        </div>
                        <img src="${item.image}" class="campus-image" onerror="this.src='https://placehold.co/400x300/002244/FFFFFF?text=No+Image'">
                        <div class="campus-info">
                            <h3>${item.name}</h3>
                            <p>${item.description}</p>
                        </div>
                    </div>
                `;
            });

            // Current Campus
            const cur = globalData.current_campus || {};
            document.getElementById('current-campus-img').src = cur.image;
            document.getElementById('current-campus-caption').innerText = cur.caption;

            // Facilities
            document.getElementById('facilities-description').innerText = (globalData.schoolInfo || {}).facilities || "No text available.";
        }

        // --- 4. MODAL LOGIC ---
        function openEditModal(type, index = null) {
            editContext = type;
            editIndex = index;
            const modalBody = document.getElementById('modal-body');
            document.getElementById('edit-modal').style.display = 'flex';
            document.getElementById('modal-title').innerText = "Edit " + type.toUpperCase().replace('_', ' ');

            let html = '';
            const imgInput = `<div class="form-group"><label>Upload Image (Optional)</label><input type="file" id="inp-file" accept="image/*"></div>`;

            if(type === 'hero') {
                const data = globalData.hero_banner || {};
                html = `
                    <div class="form-group"><label>Title (Use &lt;br&gt; for line break)</label><input id="inp-title" value="${data.title || ''}"></div>
                    <div class="form-group"><label>Subtitle</label><input id="inp-sub" value="${data.subtitle || ''}"></div>
                    ${imgInput}
                `;
            } else if (type === 'timeline') {
                const data = globalData.timeline[index] || {};
                html = `
                    <div class="form-group"><label>Year</label><input type="number" id="inp-year" value="${data.year}"></div>
                    <div class="form-group"><label>Title</label><input id="inp-title" value="${data.title}"></div>
                    <div class="form-group"><label>Description</label><textarea id="inp-desc">${data.description}</textarea></div>
                    <div class="form-group"><label>Image Caption</label><input id="inp-cap" value="${data.caption || ''}"></div>
                    ${imgInput}
                `;
            } else if (type === 'campus') {
                const data = globalData.campuses[index] || {};
                html = `
                    <div class="form-group"><label>Campus Name</label><input id="inp-name" value="${data.name}"></div>
                    <div class="form-group"><label>Description</label><textarea id="inp-desc">${data.description}</textarea></div>
                    ${imgInput}
                `;
            } else if (type === 'current_campus') {
                const data = globalData.current_campus || {};
                html = `
                    <div class="form-group"><label>Caption</label><input id="inp-cap" value="${data.caption}"></div>
                    ${imgInput}
                `;
            } else if (type === 'facilities') {
                const data = globalData.schoolInfo || {};
                html = `
                    <div class="form-group"><label>Description</label><textarea id="inp-fac" style="height:200px">${data.facilities}</textarea></div>
                `;
            }

            modalBody.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // --- 5. PREVIEW LOGIC ---
        async function saveModalChanges() {
            const fileInput = document.getElementById('inp-file');
            let imgUrl = null;

            // Image Upload
            if(fileInput && fileInput.files[0]) {
                const btn = document.querySelector('.modal-actions .btn-edit');
                btn.innerText = "Uploading...";
                btn.disabled = true;
                try {
                    imgUrl = await uploadImage(fileInput.files[0]);
                } catch(e) {
                    alert("Upload Failed: " + e.message);
                    btn.innerText = "Update Preview";
                    btn.disabled = false;
                    return;
                }
            }

            // Update State
            if(editContext === 'hero') {
                if(!globalData.hero_banner) globalData.hero_banner = {};
                globalData.hero_banner.title = document.getElementById('inp-title').value;
                globalData.hero_banner.subtitle = document.getElementById('inp-sub').value;
                if(imgUrl) globalData.hero_banner.image = imgUrl;
            } 
            else if (editContext === 'timeline') {
                const item = globalData.timeline[editIndex];
                item.year = document.getElementById('inp-year').value;
                item.title = document.getElementById('inp-title').value;
                item.description = document.getElementById('inp-desc').value;
                item.caption = document.getElementById('inp-cap').value;
                if(imgUrl) item.image = imgUrl;
            }
            else if (editContext === 'campus') {
                const item = globalData.campuses[editIndex];
                item.name = document.getElementById('inp-name').value;
                item.description = document.getElementById('inp-desc').value;
                if(imgUrl) item.image = imgUrl;
            }
            else if (editContext === 'current_campus') {
                if(!globalData.current_campus) globalData.current_campus = {};
                globalData.current_campus.caption = document.getElementById('inp-cap').value;
                if(imgUrl) globalData.current_campus.image = imgUrl;
            }
            else if (editContext === 'facilities') {
                if(!globalData.schoolInfo) globalData.schoolInfo = {};
                globalData.schoolInfo.facilities = document.getElementById('inp-fac').value;
            }

            closeModal();
            renderAll();
        }

        async function uploadImage(file) {
            const fileName = `history/${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${file.name.split('.').pop()}`;
            const { error } = await supabase.storage.from('zsnhs').upload(fileName, file);
            if (error) throw error;
            const { data } = supabase.storage.from('zsnhs').getPublicUrl(fileName);
            return data.publicUrl;
        }

        // --- 6. ADD / DELETE LOGIC ---
        function addItem(type) {
            if(type === 'timeline') {
                const newOrder = globalData.timeline.length + 1;
                globalData.timeline.push({ year: 2024, title: "New Event", description: "Details...", image: "", caption: "", order: newOrder });
                renderAll();
                openEditModal('timeline', globalData.timeline.length - 1);
            } else if (type === 'campus') {
                globalData.campuses.push({ name: "New Campus", description: "Details...", image: "" });
                renderAll();
                openEditModal('campus', globalData.campuses.length - 1);
            }
        }

        function deleteItem(type, index) {
            if(confirm("Delete this item?")) {
                if(type === 'timeline') globalData.timeline.splice(index, 1);
                if(type === 'campus') globalData.campuses.splice(index, 1);
                renderAll();
            }
        }

        // --- 7. DATABASE COMMIT ---
        async function saveToDatabase() {
            const btn = document.querySelector('.save-btn');
            btn.innerText = "SAVING...";
            btn.disabled = true;

            try {
                // Ensure Timeline order matches array index
                if(globalData.timeline) {
                    globalData.timeline.forEach((item, i) => item.order = i + 1);
                }

                await db.collection('history').doc('pageContent').set(globalData);
                alert("Changes saved successfully!");
            } catch (e) {
                console.error(e);
                alert("Error saving: " + e.message);
            } finally {
                btn.innerText = "SAVE CHANGES";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Teacher Management - ZSNHS</title>
      <link rel="stylesheet" href="admin-css/styles.css" />
      <link
         rel="stylesheet"
         href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
         />
      <link
         href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap"
         rel="stylesheet"
         />
   </head>
   <body>
      <div class="overlay" id="mobile-overlay"></div>
      <div id="preloader">
         <div class="spinner"></div>
         <div class="loading-text">ZSNHS...</div>
      </div>
      <div class="dashboard">
         <div class="sidebar" id="sidebar">
            <div class="logo">
               <div class="logo-placeholder">ZSNHS</div>
               <h1>ZSNHS</h1>
            </div>
            <div class="nav-menu">
               <h2>Dashboard</h2>
               <div class="nav-item" onclick="window.location.href='admin.html'">
                  <i class="fas fa-tachometer-alt"></i> <span>Overview</span>
               </div>
               <div class="nav-item" onclick="toggleDropdown('academics-dropdown', this)">
                  <div style="display:flex; align-items:center; gap: 15px;">
                     <i class="fas fa-graduation-cap"></i> 
                     <span>Academics</span>
                  </div>
                  <i class="fas fa-chevron-down chevron-icon"></i>
               </div>
               <div class="nav-dropdown" id="academics-dropdown">
                  <a href="teachers.html" class="nav-sub-item active">Teacher Management</a>
                  <a href="subjects.html" class="nav-sub-item">Subjects</a>
                  <a href="sections.html" class="nav-sub-item">Grade Level & Sections</a>
                  <a href="schedules.html" class="nav-sub-item">Class Schedules</a>
               </div>
               <div class="nav-item" onclick="window.location.href='guidance.html'">
                  <i class="fas fa-hands-helping"></i> <span>Guidance</span>
               </div>
               <div class="nav-item" onclick="window.location.href='students.html'">
                  <i class="fas fa-user-graduate"></i> <span>Students</span>
               </div>
               <div class="nav-item" onclick="window.location.href='parent.html'">
                  <i class="fas fa-users"></i> <span>Parents</span>
               </div>
               <div class="nav-item" onclick="window.location.href='reports.html'">
                  <i class="fas fa-chart-pie"></i> <span>Reports</span>
               </div>
               <div class="nav-item" onclick="window.location.href='settings.html'">
                  <i class="fas fa-cog"></i> <span>Settings</span>
               </div>
            </div>
            <div class="logout-container">
               <button class="logout-btn" onclick="logout()">
               <i class="fas fa-sign-out-alt"></i> Log out
               </button>
            </div>
         </div>
         <div class="main-content">
            <div class="header">
               <i class="fas fa-bars menu-toggle" id="menu-toggle-btn"></i>
               <h1>Teacher Management</h1>
               <div class="user-profile">
                  <div class="avatar-placeholder">A</div>
                  <span>Admin</span>
               </div>
            </div>
            <div class="content-section">
               <div
                  style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 20px;
                  "
                  >
                  <h2 style="color: var(--primary-color)">Teacher List</h2>
                  <div style="display: flex; gap: 10px">
                     <input
                        type="text"
                        id="search-input"
                        onkeyup="searchTeachers()"
                        placeholder="Search by name or ID..."
                        style="
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 5px;
                        width: 250px;
                        "
                        />
                     <button class="btn btn-secondary" onclick="showArchivedModal()" style="background-color: #6c757d; color: white;">
                     <i class="fas fa-archive"></i> View Archived
                     </button>
                     <button class="btn btn-primary" onclick="showAddTeacherModal()">
                     <i class="fas fa-plus"></i> Add Teacher
                     </button>
                  </div>
               </div>
               <table class="teachers-table">
                  <thead>
                     <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Class Load</th>
                        <th style="text-align: right">Actions</th>
                     </tr>
                  </thead>
                  <tbody id="teachers-list-body">
                     <tr>
                        <td colspan="5" class="loading-cell">Loading data...</td>
                     </tr>
                  </tbody>
               </table>
            </div>
         </div>
      </div>
      <div id="add-teacher-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
               <h2>Add New Teacher</h2>
               <span class="close-modal" onclick="closeModal('add-teacher-modal')">&times;</span>
            </div>
            <div class="modal-body">
               <form id="add-teacher-form" onsubmit="event.preventDefault(); addNewTeacher();">
                  <div class="form-group">
                     <label>Teacher ID (Manual)</label>
                     <input type="text" id="new-id" class="form-control" placeholder="e.g. T-2023-001" required />
                  </div>
                  <div class="form-row" style="display: flex; gap: 10px">
                     <div class="form-group" style="flex: 1">
                        <label>First Name</label>
                        <input type="text" id="new-firstname" class="form-control" required />
                     </div>
                     <div class="form-group" style="flex: 1">
                        <label>Middle Name</label>
                        <input type="text" id="new-middlename" class="form-control" placeholder="Optional" />
                     </div>
                     <div class="form-group" style="flex: 1">
                        <label>Last Name</label>
                        <input type="text" id="new-lastname" class="form-control" required />
                     </div>
                  </div>
                  <div class="form-group">
                     <label>Email</label>
                     <input type="email" id="new-email" class="form-control" placeholder="user@gmail.com" onkeyup="validateEmailInput('new-email', 'email-error')" required />
                     <small id="email-error" style="color: #dc3545; font-size: 0.8rem; display: none">
                     <i class="fas fa-exclamation-circle"></i> Invalid format. Must end with <strong>@gmail.com</strong>
                     </small>
                  </div>
                  <div class="form-group">
                     <label>Phone Number</label>
                     <input type="number" id="new-phone" class="form-control" placeholder="09xxxxxxxxx" onkeyup="validatePhoneInput('new-phone', 'phone-error')" required />
                     <small id="phone-error" style="color: #dc3545; font-size: 0.8rem; display: none">
                     <i class="fas fa-exclamation-circle"></i> Invalid format. Must be exactly <strong>11 digits</strong>.
                     </small>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn" onclick="closeModal('add-teacher-modal')">Cancel</button>
               <button class="btn btn-primary" onclick="addNewTeacher()">Save Teacher</button>
            </div>
         </div>
      </div>
      <div id="edit-teacher-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
               <h2>Edit Teacher</h2>
               <span class="close-modal" onclick="closeModal('edit-teacher-modal')">&times;</span>
            </div>
            <div class="modal-body">
               <form id="edit-teacher-form" onsubmit="event.preventDefault(); updateTeacher();">
                  <input type="hidden" id="edit-doc-id">
                  <div class="form-group">
                     <label>Teacher ID</label>
                     <input type="text" id="edit-id" class="form-control" readonly style="background: #e9ecef;" />
                  </div>
                  <div class="form-row" style="display: flex; gap: 10px">
                     <div class="form-group" style="flex: 1">
                        <label>First Name</label>
                        <input type="text" id="edit-firstname" class="form-control" required />
                     </div>
                     <div class="form-group" style="flex: 1">
                        <label>Middle Name</label>
                        <input type="text" id="edit-middlename" class="form-control" />
                     </div>
                     <div class="form-group" style="flex: 1">
                        <label>Last Name</label>
                        <input type="text" id="edit-lastname" class="form-control" required />
                     </div>
                  </div>
                  <div class="form-group">
                     <label>Email</label>
                     <input type="email" id="edit-email" class="form-control" onkeyup="validateEmailInput('edit-email', 'edit-email-error')" required />
                     <small id="edit-email-error" style="color: #dc3545; font-size: 0.8rem; display: none">
                     <i class="fas fa-exclamation-circle"></i> Invalid format.
                     </small>
                  </div>
                  <div class="form-group">
                     <label>Phone Number</label>
                     <input type="number" id="edit-phone" class="form-control" onkeyup="validatePhoneInput('edit-phone', 'edit-phone-error')" required />
                     <small id="edit-phone-error" style="color: #dc3545; font-size: 0.8rem; display: none">
                     <i class="fas fa-exclamation-circle"></i> Invalid format.
                     </small>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn" onclick="closeModal('edit-teacher-modal')">Cancel</button>
               <button class="btn btn-primary" onclick="updateTeacher()">Update Teacher</button>
            </div>
         </div>
      </div>
      <div id="archive-teacher-modal" class="modal">
         <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
               <h2>Archived Teachers</h2>
               <span class="close-modal" onclick="closeModal('archive-teacher-modal')">&times;</span>
            </div>
            <div class="modal-body">
               <p style="margin-bottom: 15px; color: #666;">
                  <i class="fas fa-info-circle"></i> Archived teachers can be restored or permanently deleted.
               </p>
               <table class="teachers-table">
                  <thead>
                     <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Archived Date</th>
                        <th style="text-align: right; min-width: 220px;">Actions</th>
                     </tr>
                  </thead>
                  <tbody id="archived-list-body">
                  </tbody>
               </table>
            </div>
            <div class="modal-footer">
               <button class="btn" onclick="closeModal('archive-teacher-modal')">Close</button>
            </div>
         </div>
      </div>
      <div id="view-teacher-modal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
               <h2>Teacher Details</h2>
               <span class="close-modal" onclick="closeModal('view-teacher-modal')">&times;</span>
            </div>
            <div class="modal-body">
               <div class="profile-view">
                  <div class="profile-avatar-large" id="view-avatar"></div>
                  <h3 id="view-fullname" style="color: var(--text-dark); margin-bottom: 5px"></h3>
                  <span id="view-id" style="color: var(--text-light); font-size: 0.9rem"></span>
               </div>
               <div class="detail-row">
                  <span class="detail-label">Middle Name:</span>
                  <span class="detail-value" id="view-middlename"></span>
               </div>
               <div class="detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value" id="view-phone"></span>
               </div>
               <div class="detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value" id="view-email"></span>
               </div>
               <div class="detail-row" style="align-items: center">
                  <span class="detail-label">Password:</span>
                  <span class="detail-value" id="view-password" style="font-family: monospace; letter-spacing: 1px; color: #d63384; font-weight: bold; margin-right: 10px;">********</span>
                  <i class="fas fa-eye" id="toggle-password-btn" onclick="togglePasswordView()" style="cursor: pointer; color: #666"></i>
               </div>
               <div class="detail-row">
                  <span class="detail-label">Date Created:</span>
                  <span class="detail-value" id="view-timestamp"></span>
               </div>
               <div class="detail-row">
                  <span class="detail-label">Status:</span>
                  <span class="detail-value" id="view-status"></span>
               </div>
            </div>
            <div class="modal-footer">
               <button class="btn" onclick="closeModal('view-teacher-modal')">Close</button>
            </div>
         </div>
      </div>
      <div id="view-schedules-modal" class="modal">
         <div class="modal-content" style="max-width: 700px">
            <div class="modal-header">
               <h2 id="schedules-modal-title">Class Schedules</h2>
               <span class="close-modal" onclick="closeModal('view-schedules-modal')">&times;</span>
            </div>
            <div class="modal-body">
               <div id="schedules-loading" style="text-align: center; padding: 20px">
                  <i class="fas fa-spinner fa-spin"></i> Loading schedules...
               </div>
               <table class="teachers-table" id="teacher-schedules-table" style="display: none; width: 100%; margin-top: 0">
                  <thead>
                     <tr>
                        <th>Subject</th>
                        <th>Section</th>
                        <th>Day & Time</th>
                     </tr>
                  </thead>
                  <tbody id="teacher-schedules-body"></tbody>
               </table>
               <p id="schedules-empty" style="display: none; text-align: center; color: #666; padding: 20px;">
                  No schedules assigned to this teacher.
               </p>
            </div>
            <div class="modal-footer">
               <button class="btn" onclick="closeModal('view-schedules-modal')">Close</button>
            </div>
         </div>
      </div>
      <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
      <script src="admin-js/admin-config.js"></script>
      <script>
         function toggleDropdown(id, el) {
           document.getElementById(id).classList.toggle("show");
           el.classList.toggle("dropdown-open");
         }
      </script>
      <script src="admin-js/ui.js"></script>
      <!--<script src="admin-js/teacher.js?v=2"></script>-->
      <script>/**
         * teacher.js
         * Manages Personnel & Displays Workloads
         */
         
         let allTeachers = [];
         let archivedTeachers = [];
         let currentViewPassword = "";
         
         document.addEventListener("DOMContentLoaded", () => {
          setTimeout(() => {
            if (window.db) {
              console.log("Database connected. Fetching teachers...");
              loadTeachersWithLoad();
            } else {
              console.error("Firebase DB not initialized.");
            }
          }, 500);
         
          window.onclick = function (event) {
            if (event.target.classList.contains("modal")) {
              event.target.style.display = "none";
            }
            if (
              !event.target.closest(".action-menu-container") &&
              !event.target.closest("#toggle-password-btn")
            ) {
              const dropdowns = document.getElementsByClassName("action-dropdown");
              for (let i = 0; i < dropdowns.length; i++) {
                dropdowns[i].classList.remove("show");
              }
            }
          };
         });
         
         // --- HELPER: Generate Password ---
         function generatePassword() {
          const chars =
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
          let password = "";
          for (let i = 0; i < 6; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          return password;
         }
         
         // --- VALIDATION FUNCTIONS ---
         
         function validateEmailInput() {
          const email = document.getElementById("new-email").value;
          const errorMsg = document.getElementById("email-error");
         
          if (email.length > 0 && !email.endsWith("@gmail.com")) {
            errorMsg.style.display = "block";
            return false;
          } else {
            errorMsg.style.display = "none";
            return true;
          }
         }
         
         function validatePhoneInput() {
          const phone = document.getElementById("new-phone").value;
          const errorMsg = document.getElementById("phone-error");
         
          if (phone.length > 0 && phone.length !== 11) {
            errorMsg.style.display = "block";
            return false;
          } else {
            errorMsg.style.display = "none";
            return true;
          }
         }
         
         // 1. FETCH ACTIVE DATA
         async function loadTeachersWithLoad() {
          const tableBody = document.getElementById("teachers-list-body");
          if (allTeachers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="loading-cell">Loading personnel...</td></tr>';
          }
         
          try {
            // Only fetch active users for the main list
            const teachersSnap = await window.db
              .collection("users")
              .where("role", "==", "teacher")
              .get();
         
            const schedulesSnap = await window.db.collection("classSessions").get();
         
            const loadCounts = {};
            schedulesSnap.forEach((doc) => {
              const s = doc.data();
              const teacherName = s.teacher || s.teacherName;
              if (teacherName) {
                loadCounts[teacherName] = (loadCounts[teacherName] || 0) + 1;
              }
            });
         
            allTeachers = [];
            
            teachersSnap.forEach((doc) => {
              const data = doc.data();
              
              // Filter Active users here
              if (data.status !== "Archived") {
                  const fullName = `${data.firstName} ${data.lastName}`;
         
                  let createdStr = "N/A";
                  if (data.createdAt && data.createdAt.toDate) {
                    createdStr = data.createdAt.toDate().toLocaleDateString();
                  } else if (data.createdAt) {
                    createdStr = new Date(data.createdAt).toLocaleDateString();
                  }
         
                  allTeachers.push({
                    docId: doc.id,
                    id: data.userId || "N/A",
                    firstName: data.firstName || "",
                    middleName: data.middleName || "",
                    lastName: data.lastName || "",
                    fullName: fullName,
                    email: data.email || "",
                    phone: data.phone || "N/A",
                    status: data.status || "Active",
                    password: data.password || "******",
                    createdAtStr: createdStr,
                    classCount: loadCounts[fullName] || 0,
                  });
              }
            });
         
            if (allTeachers.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No active teachers found.</td></tr>';
            } else {
              renderTable(allTeachers);
            }
          } catch (error) {
            console.error("Error:", error);
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error: ${error.message}</td></tr>`;
          }
         }
         
         // 2. RENDER ACTIVE TABLE
         function renderTable(data) {
          const tableBody = document.getElementById("teachers-list-body");
          tableBody.innerHTML = "";
         
          if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No matches found.</td></tr>';
            return;
          }
         
          data.forEach((teacher) => {
            const row = document.createElement("tr");
         
            let badgeStyle =
              teacher.classCount === 0
                ? "background:#ffebee; color:#c62828; border:none; cursor:pointer;"
                : "background:#e8f5e9; color:#2e7d32; border:none; cursor:pointer;";
         
            const countBadge = `<span class="badge-success" style="${badgeStyle}" onclick="viewTeacherSchedules('${teacher.fullName}')">
                                        ${teacher.classCount} Classes
                                    </span>`;
         
            row.innerHTML = `
                    <td><strong>${teacher.id}</strong></td>
                    <td>${teacher.fullName}</td>
                    <td>${teacher.email}</td>
                    <td>${countBadge}</td> 
                    <td style="text-align: right;">
                        <div class="action-menu-container">
                            <button class="btn-icon" onclick="toggleActionMenu('menu-${teacher.docId}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div id="menu-${teacher.docId}" class="action-dropdown">
                                <div onclick="viewTeacherDetails('${teacher.docId}')">
                                    <i class="fas fa-eye" style="color:#6c757d"></i> View Profile
                                </div>
                                <div onclick="openEditModal('${teacher.docId}')">
                                    <i class="fas fa-edit" style="color:#ffc107"></i> Edit
                                </div>
                                <div onclick="archiveTeacher('${teacher.docId}')">
                                    <i class="fas fa-archive" style="color:#dc3545"></i> Archive
                                </div>
                            </div>
                        </div>
                    </td>
                `;
            tableBody.appendChild(row);
          });
         }
         // // 3. ADD NEW TEACHER
         // function addNewTeacher() {
         //   const id = document.getElementById("new-id").value;
         //   const firstName = document.getElementById("new-firstname").value;
         //   const middleName = document.getElementById("new-middlename").value;
         //   const lastName = document.getElementById("new-lastname").value;
         //   const email = document.getElementById("new-email").value;
         //   const phone = document.getElementById("new-phone").value;
         
         //   // Check basic required fields
         //   if (!id || !firstName || !lastName || !email || !phone) {
         //     alert("Please fill in required fields.");
         //     return;
         //   }
         
         //   // Run format validations
         //   if (!validateEmailInput() || !validatePhoneInput()) {
         //     alert("Please correct the errors in the form (Email or Phone).");
         //     return;
         //   }
         
         //   const password = generatePassword();
         
         //   const newTeacher = {
         //     userId: id, // Manual ID from Input
         //     password: password,
         //     firstName: firstName,
         //     middleName: middleName,
         //     lastName: lastName,
         //     email: email,
         //     phone: phone,
         //     status: "Active",
         //     role: "teacher",
         //     createdAt: new Date(),
         //   };
         
         //   const btn = document.querySelector("#add-teacher-modal .btn-primary");
         //   const originalText = btn.innerText;
         //   btn.innerText = "Saving...";
         //   btn.disabled = true;
         
         //   window.db
         //     .collection("users")
         //     .add(newTeacher)
         //     .then(() => {
         //       alert(
         //         `Teacher Added Successfully!\n\nID: ${id}\nPassword: ${password}\nEmail:${email}`
         //       );
         //       closeModal("add-teacher-modal");
         //       loadTeachersWithLoad();
         //     })
         //     .catch((error) => {
         //       alert("Error: " + error.message);
         //     })
         //     .finally(() => {
         //       btn.innerText = originalText;
         //       btn.disabled = false;
         //     });
         // }
         // 3. ADD NEW TEACHER WITH EMAIL NOTIFICATION (Updated error handling)
         async function addNewTeacher() {
          const id = document.getElementById("new-id").value;
          const firstName = document.getElementById("new-firstname").value;
          const middleName = document.getElementById("new-middlename").value;
          const lastName = document.getElementById("new-lastname").value;
          const email = document.getElementById("new-email").value;
          const phone = document.getElementById("new-phone").value;
         
         // Check basic required fields
          if (!id || !firstName || !lastName || !email || !phone) {
            alert("Please fill in required fields.");
            return;
          }
         
          // Run format validations
          if (!validateEmailInput() || !validatePhoneInput()) {
            alert("Please correct the errors in the form (Email or Phone).");
            return;
          }
         
          // Check for duplicate ID
          const idExists = await checkIfUserExists('userId', id);
          if (idExists) {
            alert(`Error: User ID "${id}" already exists. Please use a different ID.`);
            return;
          }
         
          // Check for duplicate email
          const emailExists = await checkIfUserExists('email', email);
          if (emailExists) {
            alert(`Error: Email "${email}" is already registered. Please use a different email.`);
            return;
          }
         
          const password = generatePassword();
         
          const newTeacher = {
            userId: id,
            password: password,
            firstName: firstName,
            middleName: middleName,
            lastName: lastName,
            email: email,
            phone: phone,
            status: "Active",
            role: "teacher",
            createdAt: new Date(),
          };
         
          const btn = document.querySelector("#add-teacher-modal .btn-primary");
          const originalText = btn.innerText;
          btn.innerText = "Saving...";
          btn.disabled = true;
         
          try {
            // Step 1: Save to Firebase
            await window.db.collection("users").add(newTeacher);
            
            // Step 2: Try to send email
            const emailResult = await sendTeacherCredentials({
              email: email,
              id: id,
              password: password,
              firstName: firstName,
              lastName: lastName
            });
            
            if (emailResult.success) {
              alert(`Teacher Added Successfully!\n\nID: ${id}\nPassword: ${password}\n\nCredentials have been sent to: ${email}`);
            } else {
              alert(`Teacher Added Successfully!\n\nID: ${id}\nPassword: ${password}\n\nBUT email failed to send: ${emailResult.message}\n\nPlease provide these credentials manually to the teacher.`);
            }
            
            // Close modal and refresh
            closeModal("add-teacher-modal");
            loadTeachersWithLoad();
            
          } catch (error) {
            console.error("Error:", error);
            
            // Check if it's a Firebase error
            if (error.message && error.message.includes("Firebase")) {
              alert("Error saving teacher to database: " + error.message);
            } else {
              alert("Unexpected error: " + error.message);
            }
          } finally {
            btn.innerText = originalText;
            btn.disabled = false;
          }
         }
         // 4. SEND EMAIL FUNCTION - FIXED PATH
         async function sendTeacherCredentials(teacherData) {
          try {
            console.log('Attempting to send email...');
            
            // Try different possible paths
            const possiblePaths = [
              'send-teacher-credentials.php',
              './send-teacher-credentials.php',
              'admin-js/send-teacher-credentials.php',
              '/admin/admin-js/send-teacher-credentials.php'
            ];
            
            let response;
            let successfulPath;
            
            // Try each path until one works
            for (const path of possiblePaths) {
              try {
                console.log('Trying path:', path);
                response = await fetch(path, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(teacherData),
                  mode: 'cors'
                });
                
                if (response.ok) {
                  successfulPath = path;
                  console.log('Success with path:', path);
                  break;
                } else if (response.status !== 404) {
                  // If it's not 404, we found the file but it has an error
                  successfulPath = path;
                  break;
                }
              } catch (err) {
                console.log('Failed with path', path, ':', err.message);
              }
            }
            
            if (!response) {
              throw new Error('Could not find email endpoint. All paths failed.');
            }
            
            console.log('Response status:', response.status);
            
            const text = await response.text();
            console.log('Response text:', text.substring(0, 200));
            
            let result;
            try {
              result = JSON.parse(text);
            } catch (e) {
              throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
            }
            
            if (!result.success) {
              throw new Error(result.message || 'Email sending failed');
            }
            
            return result;
            
          } catch (error) {
            console.error('Email error:', error);
            return {
              success: false,
              message: error.message,
              credentials: {
                id: teacherData.id,
                password: teacherData.password
              }
            };
          }
         }
         
         // NEW FUNCTION: Check if user with specific field value already exists
         async function checkIfUserExists(field, value) {
          try {
            const querySnapshot = await window.db
              .collection("users")
              .where(field, "==", value)
              .get();
            
            return !querySnapshot.empty;
          } catch (error) {
            console.error("Error checking user existence:", error);
            return false;
          }
         }
         // --- EDIT FUNCTIONALITY ---
         function openEditModal(docId) {
            const teacher = allTeachers.find(t => t.docId === docId);
            if (!teacher) return;
         
            document.getElementById('edit-doc-id').value = docId;
            document.getElementById('edit-id').value = teacher.id;
            document.getElementById('edit-firstname').value = teacher.firstName;
            document.getElementById('edit-middlename').value = teacher.middleName;
            document.getElementById('edit-lastname').value = teacher.lastName;
            document.getElementById('edit-email').value = teacher.email;
            document.getElementById('edit-phone').value = teacher.phone;
            
            // Clear errors
            document.getElementById('edit-email-error').style.display = 'none';
            document.getElementById('edit-phone-error').style.display = 'none';
         
            document.getElementById('edit-teacher-modal').style.display = 'block';
         }
         function updateTeacher() {
            const docId = document.getElementById('edit-doc-id').value;
            const firstName = document.getElementById('edit-firstname').value;
            const middleName = document.getElementById('edit-middlename').value;
            const lastName = document.getElementById('edit-lastname').value;
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;
         
            if (!firstName || !lastName || !email || !phone) {
                alert("Please fill in required fields.");
                return;
            }
         
            if (!validateEmailInput('edit-email', 'edit-email-error') || 
                !validatePhoneInput('edit-phone', 'edit-phone-error')) {
                alert("Please correct errors.");
                return;
            }
         
            const btn = document.querySelector("#edit-teacher-modal .btn-primary");
            const originalText = btn.innerText;
            btn.innerText = "Updating...";
            btn.disabled = true;
         
            window.db.collection("users").doc(docId).update({
                firstName: firstName,
                middleName: middleName,
                lastName: lastName,
                email: email,
                phone: phone
            })
            .then(() => {
                alert("Teacher updated successfully!");
                closeModal("edit-teacher-modal");
                loadTeachersWithLoad();
            })
            .catch((error) => {
                alert("Error updating: " + error.message);
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
         }
         function loadArchivedTeachers() {
            window.db.collection('users')
                .where('role', '==', 'teacher')
                .where('status', '==', 'Archived')
                .get()
                .then((querySnapshot) => {
                    archivedTeachers = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        let archivedStr = "N/A";
                        if (data.archivedAt && data.archivedAt.toDate) {
                            archivedStr = data.archivedAt.toDate().toLocaleDateString() + ' ' + data.archivedAt.toDate().toLocaleTimeString();
                        }
         
                        archivedTeachers.push({
                            docId: doc.id,
                            id: data.userId || 'N/A',
                            fullName: `${data.firstName} ${data.lastName}`,
                            firstName: data.firstName,
                            middleName: data.middleName,
                            lastName: data.lastName,
                            email: data.email,
                            phone: data.phone,
                            password: data.password,
                            status: 'Archived',
                            archivedAtStr: archivedStr,
                            createdAtStr: archivedStr // Reuse for view detail
                        });
                    });
                    // If modal is open, refresh it
                    const modal = document.getElementById('archive-teacher-modal');
                    if (modal.style.display === 'block') {
                        showArchivedModal();
                    }
                });
         }
         
         async function showArchivedModal() {
            const listBody = document.getElementById('archived-list-body');
            listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading archived teachers...</td></tr>';
            
            // Show modal immediately
            document.getElementById('archive-teacher-modal').style.display = 'block';
            
            try {
                // Fetch archived teachers
                const querySnapshot = await window.db.collection('users')
                    .where('role', '==', 'teacher')
                    .where('status', '==', 'Archived')
                    .get();
                
                archivedTeachers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let archivedStr = "N/A";
                    if (data.archivedAt && data.archivedAt.toDate) {
                        archivedStr = data.archivedAt.toDate().toLocaleDateString() + ' ' + data.archivedAt.toDate().toLocaleTimeString();
                    } else if (data.archivedAt) {
                        archivedStr = new Date(data.archivedAt).toLocaleDateString();
                    }
         
                    archivedTeachers.push({
                        docId: doc.id,
                        id: data.userId || 'N/A',
                        fullName: `${data.firstName || ''} ${data.lastName || ''}`.trim(),
                        firstName: data.firstName || '',
                        middleName: data.middleName || '',
                        lastName: data.lastName || '',
                        email: data.email || '',
                        phone: data.phone || '',
                        password: data.password || '',
                        status: 'Archived',
                        archivedAtStr: archivedStr
                    });
                });
                
                // Now render the table
                renderArchivedTable();
                
            } catch (error) {
                console.error("Error loading archived teachers:", error);
                listBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error: ${error.message}</td></tr>`;
            }
         }
         
         function renderArchivedTable() {
            const listBody = document.getElementById('archived-list-body');
            listBody.innerHTML = '';
            
            if (archivedTeachers.length === 0) {
                listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No archived teachers found.</td></tr>';
            } else {
                archivedTeachers.forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.fullName}</td>
                        <td>${t.email}</td>
                        <td>${t.phone}</td>
                        <td>${t.archivedAtStr}</td>
                        <td style="text-align: right;">
                            <div style="display: flex; gap: 5px; justify-content: flex-end;">
                                <button onclick="viewTeacherDetails('${t.docId}')" title="View" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="restoreTeacher('${t.docId}')" title="Restore" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button onclick="deleteTeacherPermanent('${t.docId}')" title="Delete" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    listBody.appendChild(row);
                });
            }
         }
         
         function archiveTeacher(docId) {
            if (confirm("Are you sure you want to archive this teacher?")) {
                const btn = document.querySelector(`#menu-${docId}`).parentElement.querySelector('.btn-icon');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
                
                window.db.collection("users").doc(docId).update({
                    status: "Archived",
                    archivedAt: new Date()
                })
                .then(() => {
                    alert("Teacher archived successfully.");
                    // Refresh both lists
                    loadTeachersWithLoad();
                    
                    // If archive modal is open, refresh it too
                    const modal = document.getElementById('archive-teacher-modal');
                    if (modal.style.display === 'block') {
                        showArchivedModal();
                    }
                })
                .catch((err) => {
                    alert("Error: " + err.message);
                })
                .finally(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                });
            }
         }
         function restoreTeacher(docId) {
            if(confirm("Restore this teacher to Active status?")) {
                window.db.collection("users").doc(docId).update({
                    status: "Active",
                    archivedAt: null
                })
                .then(() => {
                    alert("Teacher Restored!");
                    loadTeachersWithLoad(); // Refresh active list
                    
                    // Refresh archived list if modal is open
                    const modal = document.getElementById('archive-teacher-modal');
                    if (modal.style.display === 'block') {
                        showArchivedModal();
                    }
                })
                .catch(err => alert("Error: " + err.message));
            }
         }
         
         function deleteTeacherPermanent(docId) {
            if(confirm("WARNING: This will PERMANENTLY delete this user. This cannot be undone.")) {
                window.db.collection("users").doc(docId).delete()
                .then(() => {
                    alert("Teacher Deleted Permanently.");
                    // Refresh archived list if modal is open
                    const modal = document.getElementById('archive-teacher-modal');
                    if (modal.style.display === 'block') {
                        showArchivedModal();
                    }
                })
                .catch(err => alert("Error: " + err.message));
            }
         }
         // --- UI HELPERS ---
         
         function showAddTeacherModal() {
          document.getElementById("add-teacher-form").reset();
          document.getElementById("email-error").style.display = "none";
          document.getElementById("phone-error").style.display = "none";
          document.getElementById("add-teacher-modal").style.display = "block";
         }
         
         function searchTeachers() {
          const input = document.getElementById("search-input").value.toLowerCase();
          const filtered = allTeachers.filter(
            (t) =>
              t.firstName.toLowerCase().includes(input) ||
              t.lastName.toLowerCase().includes(input) ||
              t.id.toLowerCase().includes(input)
          );
          renderTable(filtered);
         }
         
         // Updated View Logic to check both lists
         function viewTeacherDetails(docId) {
          let teacher = allTeachers.find((t) => t.docId === docId);
          if (!teacher) {
              teacher = archivedTeachers.find(t => t.docId === docId);
          }
         
          if (teacher) {
            document.getElementById("view-avatar").innerText = teacher.firstName.charAt(0);
            document.getElementById("view-fullname").innerText = teacher.fullName;
            document.getElementById("view-id").innerText = teacher.id;
            document.getElementById("view-middlename").innerText = teacher.middleName || "-";
            document.getElementById("view-phone").innerText = teacher.phone;
            document.getElementById("view-email").innerText = teacher.email;
            document.getElementById("view-timestamp").innerText = teacher.createdAtStr;
         
            currentViewPassword = teacher.password || "Not Set";
            const passField = document.getElementById("view-password");
            const icon = document.getElementById("toggle-password-btn");
            passField.innerText = "********";
            icon.className = "fas fa-eye";
         
            document.getElementById("view-status").innerText = teacher.status || "Active";
            
            // Ensure view modal is on top
            const viewModal = document.getElementById("view-teacher-modal");
            viewModal.style.zIndex = "2000";
            viewModal.style.display = "block";
          }
         }
         
         function togglePasswordView() {
          const passField = document.getElementById("view-password");
          const icon = document.getElementById("toggle-password-btn");
         
          if (passField.innerText === "********") {
            passField.innerText = currentViewPassword;
            icon.className = "fas fa-eye-slash";
          } else {
            passField.innerText = "********";
            icon.className = "fas fa-eye";
          }
         }
         
         
         function togglePasswordView() {
          const passField = document.getElementById("view-password");
          const icon = document.getElementById("toggle-password-btn");
         
          if (passField.innerText === "********") {
            passField.innerText = currentViewPassword;
            icon.className = "fas fa-eye-slash";
          } else {
            passField.innerText = "********";
            icon.className = "fas fa-eye";
          }
         }
         
         function viewTeacherSchedules(teacherName) {
          const modal = document.getElementById("view-schedules-modal");
          const title = document.getElementById("schedules-modal-title");
          const loading = document.getElementById("schedules-loading");
          const table = document.getElementById("teacher-schedules-table");
          const tbody = document.getElementById("teacher-schedules-body");
          const emptyMsg = document.getElementById("schedules-empty");
         
          title.innerText = `Schedules: ${teacherName}`;
          modal.style.display = "block";
          loading.style.display = "block";
          table.style.display = "none";
          emptyMsg.style.display = "none";
          tbody.innerHTML = "";
         
          const db = window.db;
         
          const schedulePromises = [
            db.collection("classSessions").where("teacher", "==", teacherName).get(),
            db.collection("classSessions").where("teacherName", "==", teacherName).get(),
          ];
         
          Promise.all(schedulePromises)
            .then(([querySnapshot1, querySnapshot2]) => {
              loading.style.display = "none";
              const allSchedules = [];
         
              const processSnapshot = (snapshot) => {
                snapshot.forEach((doc) => {
                  const data = doc.data();
                  const isDuplicate = allSchedules.some(
                    (s) => s.subject === data.subject && s.section === data.section
                  );
                  if (!isDuplicate) {
                    allSchedules.push(data);
                  }
                });
              };
         
              processSnapshot(querySnapshot1);
              processSnapshot(querySnapshot2);
         
              if (allSchedules.length === 0) {
                emptyMsg.style.display = "block";
                return;
              }
         
              table.style.display = "table";
         
              allSchedules.forEach((s) => {
                const row = document.createElement("tr");
                const timeStr = `${s.startTime || "?"} - ${s.endTime || "?"}`;
                row.innerHTML = `
                            <td><strong>${s.subject}</strong></td>
                            <td>${s.section}</td>
                            <td><span style="color:#e65100;">${s.days}</span> <small>${timeStr}</small></td>
                        `;
                tbody.appendChild(row);
              });
            })
            .catch((err) => {
              console.error(err);
              loading.innerText = "Error loading schedules.";
            });
         }
         
         function archiveTeacher(docId) {
          if (confirm("Are you sure you want to archive this teacher?")) {
            window.db
              .collection("users")
              .doc(docId)
              .update({
                status: "Archived",
              })
              .then(() => {
                alert("Teacher archived.");
                loadTeachersWithLoad();
              })
              .catch((err) => alert("Error: " + err.message));
          }
         }
         
         function toggleActionMenu(menuId) {
          const dropdowns = document.getElementsByClassName("action-dropdown");
          for (let i = 0; i < dropdowns.length; i++) {
            if (dropdowns[i].id !== menuId) dropdowns[i].classList.remove("show");
          }
          document.getElementById(menuId).classList.toggle("show");
         }
         
         function closeModal(modalId) {
          document.getElementById(modalId).style.display = "none";
         }
         
         // Global Export
         window.validateEmailInput = validateEmailInput;
         window.validatePhoneInput = validatePhoneInput;
         window.togglePasswordView = togglePasswordView;
      </script>
   </body>
</html>